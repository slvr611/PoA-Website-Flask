{% extends "layout.html" %}

{% block title %}Edit Nation: {{ nation.name }}{% endblock %}

{% block content %}
<div class="nation-page-container">
    <a href="{{ request.path.replace('edit', 'item') }}">Back to View</a>
    <h1>Edit Nation: {{ nation.name }}</h1>
    
    {% if g.user.is_admin %}
        {% set default_action = request.path ~ '/save' %}
    {% else %}
        {% set default_action = request.path ~ '/request' %}
    {% endif %}
    
    <form method="POST" action="{{ default_action }}">
        {{ form.csrf_token }}
        
        <!-- Main information organized in columns -->
        <div class="main-columns">
            <!-- General / Numeric Stats -->
            <div class="info-column">
                <h2>General</h2>
                <table class="info-table">
                    <tr>
                        <th>{{ form.name.label.text }}:</th>
                        <td>{{ form.name(class="form-control") }}</td>
                    </tr>
                    <tr>
                        <th>{{ form.region.label.text }}:</th>
                        <td>{{ form.region(class="form-control") }}</td>
                    </tr>
                    <tr>
                        <th>{{ form.stability.label.text }}:</th>
                        <td>{{ form.stability(class="form-control") }}</td>
                    </tr>
                    <tr>
                        <th>{{ schema.properties.stability_gain_chance.label }}:</th>
                        <td>{{ nation.stability_gain_chance }}</td>
                    </tr>
                    <tr>
                        <th>{{ schema.properties.stability_loss_chance.label }}:</th>
                        <td>{{ nation.stability_loss_chance }}</td>
                    </tr>
                    <tr>
                        <th>{{ form.infamy.label.text }}:</th>
                        <td>{{ form.infamy(class="form-control") }}</td>
                    </tr>
                    <tr>
                        <th>{{ schema.properties.karma.label }}:</th>
                        <td>{{ nation.karma }}</td>
                    </tr>
                    <tr>
                        <th>{{ form.temporary_karma.label.text }}:</th>
                        <td>{{ form.temporary_karma(class="form-control") }}</td>
                    </tr>
                    <tr>
                        <th>{{ form.rolling_karma.label.text }}:</th>
                        <td>{{ form.rolling_karma(class="form-control") }}</td>
                    </tr>
                </table>
            </div>

            <!-- Income -->
            <div class="info-column">
                <h2>Income</h2>
                <table class="info-table">
                    <tr>
                        <th>{{ form.money.label.text }}:</th>
                        <td>{{ form.money(class="form-control") }}</td>
                    </tr>
                    <tr>
                        <th>{{ schema.properties.money_capacity.label }}:</th>
                        <td>{{ nation.money_capacity }}</td>
                    </tr>
                    <tr>
                        <th>{{ schema.properties.money_income.label }}:</th>
                        <td>{{ nation.money_income }}</td>
                    </tr>
                </table>
            </div>

            <!-- Demographics -->
            <div class="info-column">
                <h2>Demographics</h2>
                <table class="info-table">
                    <tr>
                        <th>{{ form.primary_race.label.text }}:</th>
                        <td>{{ form.primary_race(class="form-control") }}</td>
                    </tr>
                    <tr>
                        <th>{{ form.primary_culture.label.text }}:</th>
                        <td>{{ form.primary_culture(class="form-control") }}</td>
                    </tr>
                    <tr>
                        <th>{{ form.primary_religion.label.text }}:</th>
                        <td>{{ form.primary_religion(class="form-control") }}</td>
                    </tr>
                    <tr>
                        <th>{{ schema.properties.unique_minority_count.label }}:</th>
                        <td>{{ nation.unique_minority_count }}</td>
                    </tr>
                </table>
                <h3>Population Details</h3>
                <table class="pops-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Race</th>
                            <th>Culture</th>
                            <th>Religion</th>
                            <th>Reason</th>
                            {% if g.user.is_admin %}
                                <th>Clone Now</th>
                            {% endif %}
                            <th>Request Clone</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pop in linked_objects["pops"] %}
                            <tr>
                                <td><a href="{{ pop["link"] }}">{{ loop.index }}</a></td>
                                <td>
                                {% if pop["linked_objects"]["race"] %}
                                    <a href="{{ pop["linked_objects"]["race"]["link"] }}">{{ pop["linked_objects"]["race"]["name"] }}</a>
                                {% else %}
                                    None
                                {% endif %}
                                </td>
                                <td>
                                {% if pop["linked_objects"]["culture"] %}
                                    <a href="{{ pop["linked_objects"]["culture"]["link"] }}">{{ pop["linked_objects"]["culture"]["name"] }}</a>
                                {% else %}
                                    None
                                {% endif %}
                                </td>
                                <td>
                                {% if pop["linked_objects"]["religion"] %}
                                    <a href="{{ pop["linked_objects"]["religion"]["link"] }}">{{ pop["linked_objects"]["religion"]["name"] }}</a>
                                {% else %}
                                    None
                                {% endif %}
                                </td>
                                
                                <td>
                                    <input type="text" id="pop_reason" name="pop_reason" value="">
                                </td>
                                
                                {% if g.user.is_admin %}
                                    <td><button type="button" onclick="window.location.href='{{ pop["link"].replace("item", "clone") }}/save'">Clone Now</button></td>
                                {% endif %}
                                <td><button type="button" onclick="window.location.href='{{ pop["link"].replace("item", "clone") }}/request'">Request Clone</button></td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Government & Laws -->
            <div class="info-column">
                <h2>Government & Laws</h2>
                <table class="info-table">
                    {% for law in schema.laws %}
                        {% if law != "stability" and law in form._fields.keys() %}
                            <tr>
                                <th>{{ form[law].label.text }}:</th>
                                <td>{{ form[law](class="form-control") }}</td>
                            </tr>
                        {% endif %}
                    {% endfor %}
                </table>
            </div>

            <!-- Administration & Holdings -->
            <div class="info-column">
                <h2>Administration & Holdings</h2>
                <table class="info-table">
                    <tr>
                        <th>{{ schema.properties.administration.label }}:</th>
                        <td>{{ nation.administration }}</td>
                    </tr>
                    <tr>
                        <th>{{ form.current_territory.label.text }}:</th>
                        <td>{{ form.current_territory(class="form-control") }}</td>
                    </tr>
                    <tr>
                        <th>{{ schema.properties.effective_territory.label }}:</th>
                        <td>{{ nation.effective_territory }}</td>
                    </tr>
                    <tr>
                        <th>{{ form.road_usage.label.text }}:</th>
                        <td>{{ form.road_usage(class="form-control") }}</td>
                    </tr>
                    <tr>
                        <th>{{ schema.properties.road_capacity.label }}:</th>
                        <td>{{ nation.road_capacity }}</td>
                    </tr>
                    <tr>
                        <th>{{ schema.properties.city_count.label }}:</th>
                        <td>{{ nation.cities }}</td>
                    </tr>
                    <tr>
                        <th>{{ schema.properties.city_slots.label }}:</th>
                        <td>{{ nation.city_slots }}</td>
                    </tr>
                </table>
            </div>
            
            <div class="info-column">
                <h2>Vassalship</h2>
                <table class="info-table">
                    <tr>
                        <th>{{ form.overlord.label.text }}:</th>
                        <td>{{ form.overlord(class="form-control") }}</td>
                    </tr>
                    <tr>
                        <th>{{ form.vassal_type.label.text }}:</th>
                        <td>{{ form.vassal_type(class="form-control") }}</td>
                    </tr>
                    <tr>
                        <th>{{ form.compliance.label.text }}:</th>
                        <td>{{ form.compliance(class="form-control") }}</td>
                    </tr>
                    <tr>
                        <th>{{ schema.properties.disobey_chance.label }}:</th>
                        <td>{{ nation.disobey_chance }}</td>
                    </tr>
                    <tr>
                        <th>{{ schema.properties.rebellion_chance.label }}:</th>
                        <td>{{ nation.rebellion_chance }}</td>
                    </tr>
                    <tr>
                        <th>{{ schema.properties.concessions_chance.label }}:</th>
                        <td>{{ nation.concessions_chance }}</td>
                    </tr>
                    <tr>
                        <th>{{ schema.properties.concessions_qty.label }}:</th>
                        <td>{{ nation.concessions_qty }}</td>
                    </tr>
                </table>
            </div>

            <!-- Miscellaneous: fields not in view -->
            <div class="info-column">
                <h2>Miscellaneous</h2>
                <table class="info-table">
                    <tr>
                        <th>{{ form.origin.label.text }}:</th>
                        <td>{{ form.origin(class="form-control") }}</td>
                    </tr>
                    <tr>
                        <th>{{ form.temperament.label.text }}:</th>
                        <td>{{ form.temperament(class="form-control") }}</td>
                    </tr>
                    <tr>
                        <th>{{ form.modifiers.label.text }}:</th>
                        <td>{{ form.modifiers(class="form-control", rows=3, style="width: 100%;") }}</td>
                    </tr>
                </table>
            </div>
        </div>

        <!-- Resources Section -->
        <section class="resources-section">
            <h2>Resources</h2>
            <table class="resources-table">
                <thead>
                    <tr class="resources-header-row">
                        <th colspan="6" class="resources-header">General Resources</th>
                    </tr>
                    <tr>
                        <th>Resource</th>
                        <th>Production</th>
                        <th>Consumption</th>
                        <th>Excess</th>
                        <th>Storage</th>
                        <th>Capacity</th>
                    </tr>
                </thead>
                <tbody>
                    {% for resource in general_resources %}
                        {% set resource_index = loop.index0 %}
                        <tr>
                            <td>{{ resource.name }}</td>
                            <td>{{ nation.resource_production[resource.key] if resource.key in nation.resource_production else 0 }}</td>
                            <td>{{ nation.resource_consumption[resource.key] if resource.key in nation.resource_consumption else 0 }}</td>
                            <td>{{ nation.resource_excess[resource.key] if resource.key in nation.resource_excess else 0 }}</td>
                            <td>{{ form.resource_storage[resource.key](class="form-control") }}</td>
                            <td>{{ nation.resource_capacity[resource.key] if resource.key in nation.resource_capacity else 0 }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
                <thead>
                    <tr class="resources-header-row">
                        <th colspan="6" class="resources-header">Unique Resources</th>
                    </tr>
                    <tr>
                        <th>Resource</th>
                        <th>Production</th>
                        <th>Consumption</th>
                        <th>Excess</th>
                        <th>Storage</th>
                        <th>Capacity</th>
                    </tr>
                </thead>
                <tbody>
                    {% for resource in unique_resources %}
                        {% set resource_index = general_resources|length + loop.index0 %}
                        <tr>
                            <td>{{ resource.name }}</td>
                            <td>{{ nation.resource_production[resource.key] if resource.key in nation.resource_production else 0 }}</td>
                            <td>{{ nation.resource_consumption[resource.key] if resource.key in nation.resource_consumption else 0 }}</td>
                            <td>{{ nation.resource_excess[resource.key] if resource.key in nation.resource_excess else 0 }}</td>
                            <td>{{ form.resource_storage[resource.key](class="form-control") }}</td>
                            <td>{{ nation.resource_capacity[resource.key] if resource.key in nation.resource_capacity else 0 }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </section>

        <!-- Jobs Section -->
        <section class="jobs-section">
            <h2>Jobs</h2>
            <table class="jobs-table">
                <thead>
                    <tr>
                        <th>Job</th>
                        <th>Assigned Pops</th>
                        <th>Upkeep</th>
                        <th>Production</th>
                    </tr>
                </thead>
                <tbody>
                    {% for job, details in nation.job_details.items() %}
                        <tr>
                            <td>{{ details.display_name }}</td>
                            <td>{{ form.jobs[job] }}</td>
                            <td>
                            {% if details.upkeep is defined %}
                                {% for resource, cost in details.upkeep.items() %}
                                    {{ resource }}: {{ cost }}<br>
                                {% endfor %}
                            {% endif %}
                            </td>
                            <td>
                            {% if details.production is defined %}
                                {% for resource, prod in details.production.items() %}
                                    {{ resource }}: {{ prod }}<br>
                                {% endfor %}
                            {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </section>
        
        <!-- Districts Section -->
        <section class="districts-section">
            <h2>Districts</h2>
            <p>{{ schema.properties.district_slots.label }}: {{ nation.district_slots }}</p>
            <div class="districts-grid">
                {% for district_field in form.districts %}
                    <div class="district-slot">
                        <label for="{{ district_field.id }}">Slot {{ loop.index }}</label>
                        {{ district_field(class="form-control") }}
                    </div>
                {% endfor %}
            </div>
        </section>
        
        <!-- Reason and Submit -->
        <div class="form-actions">
            <div class="reason-field">
                <label for="{{ form.reason.id }}">{{ form.reason.label.text }}:</label>
                {{ form.reason(class="form-control") }}
            </div>
            
            {% if g.user.is_admin %}
                <button type="submit" formaction="{{ request.path }}/save" class="btn btn-primary">Save</button>
            {% endif %}
            <button type="submit" formaction="{{ request.path }}/request" class="btn btn-secondary">Request</button>
        </div>
    </form>
</div>
{% endblock %}

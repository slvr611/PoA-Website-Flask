{% extends "layout.html" %}

{% block title %}Path of Ages - Interactive Hex Map{% endblock %}

{% block content %}
<div class="hex-map-container">
    <div class="map-controls">
        <div class="button-group">
            <button id="terrain-view-btn" class="map-btn active">Terrain View</button>
            <button id="political-view-btn" class="map-btn">Political View</button>
            <button id="nodes-view-btn" class="map-btn">Nodes View</button>
        </div>
        <div class="zoom-controls">
            <button id="zoom-in-btn" class="control-btn">+</button>
            <button id="zoom-out-btn" class="control-btn">-</button>
            <button id="center-btn" class="control-btn">Center</button>
        </div>
    </div>
    
    <div class="map-main-area">
        <div class="map-canvas-container">
            <canvas id="hex-map-canvas" width="800" height="600"></canvas>
            <canvas id="background-canvas" width="800" height="600"></canvas>
        </div>
        
        <div class="tile-details-panel">
            <div class="panel-header">
                <h3>Tile Details</h3>
            </div>
            <div class="panel-content" id="tile-details-content">
                <p class="no-selection">Click on a tile to view details</p>
            </div>
        </div>
    </div>
    
    <div class="map-legend">
        <div class="legend-section">
            <h4>Terrain Types</h4>
            <div class="terrain-legend">
                <div class="legend-item"><span class="terrain-color plains"></span> Plains</div>
                <div class="legend-item"><span class="terrain-color forest"></span> Forest</div>
                <div class="legend-item"><span class="terrain-color hills"></span> Hills</div>
                <div class="legend-item"><span class="terrain-color mountains"></span> Mountains</div>
                <div class="legend-item"><span class="terrain-color desert"></span> Desert</div>
                <div class="legend-item"><span class="terrain-color swamp"></span> Swamp</div>
                <div class="legend-item"><span class="terrain-color coast"></span> Coast</div>
                <div class="legend-item"><span class="terrain-color ocean"></span> Ocean</div>
                <div class="legend-item"><span class="terrain-color river"></span> River</div>
            </div>
        </div>
        
        <div class="legend-section" id="nations-legend" style="display: none;">
            <h4>Nations</h4>
            <div id="nations-legend-content">
                <!-- Nations will be populated by JavaScript -->
            </div>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/hexmap.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize the hex map
    const hexMap = new HexMap('hex-map-canvas', 'background-canvas');
    
    // Load map data
    hexMap.loadMapData().then(() => {
        hexMap.render();
    }).catch(error => {
        console.error('Failed to load map data:', error);
    });
    
    // View mode buttons
    document.getElementById('terrain-view-btn').addEventListener('click', function() {
        hexMap.setViewMode('terrain');
        updateActiveButton(this);
        document.getElementById('nations-legend').style.display = 'none';
    });
    
    document.getElementById('political-view-btn').addEventListener('click', function() {
        hexMap.setViewMode('political');
        updateActiveButton(this);
        document.getElementById('nations-legend').style.display = 'block';
    });
    
    document.getElementById('nodes-view-btn').addEventListener('click', function() {
        hexMap.setViewMode('nodes');
        updateActiveButton(this);
        document.getElementById('nations-legend').style.display = 'none';
    });
    
    // Zoom controls
    document.getElementById('zoom-in-btn').addEventListener('click', function() {
        hexMap.zoomIn();
    });
    
    document.getElementById('zoom-out-btn').addEventListener('click', function() {
        hexMap.zoomOut();
    });
    
    document.getElementById('center-btn').addEventListener('click', function() {
        hexMap.centerView();
    });
    
    function updateActiveButton(activeBtn) {
        document.querySelectorAll('.map-btn').forEach(btn => btn.classList.remove('active'));
        activeBtn.classList.add('active');
    }
    
    // Handle tile selection
    hexMap.onTileSelect = function(tile) {
        displayTileDetails(tile);
    };
    
    function displayTileDetails(tile) {
        const content = document.getElementById('tile-details-content');
        
        if (!tile) {
            content.innerHTML = '<p class="no-selection">Click on a tile to view details</p>';
            return;
        }
        
        let html = `
            <div class="tile-info">
                <h4>Coordinates: (${tile.coordinates.q}, ${tile.coordinates.r}, ${tile.coordinates.s})</h4>
                <p><strong>Terrain:</strong> ${tile.terrain_type}</p>
        `;
        
        if (tile.nation) {
            html += `<p><strong>Controlled by:</strong> <span style="color: ${tile.nation.color}">${tile.nation.name}</span></p>`;
        }
        
        if (tile.nodes && tile.nodes.length > 0) {
            html += '<div class="nodes-section"><strong>Nodes:</strong><ul>';
            tile.nodes.forEach(node => {
                html += `<li><strong>${node.name}</strong> (${node.type})<br><small>${node.description}</small></li>`;
            });
            html += '</ul></div>';
        }
        
        if (tile.district) {
            html += `<p><strong>District:</strong> ${tile.district.id}</p>`;
        }
        
        html += '</div>';
        content.innerHTML = html;
    }
});
</script>
{% endblock %}

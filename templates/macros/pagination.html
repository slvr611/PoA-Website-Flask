{% macro render_pagination(current_page, total_pages, base_url) %}
<div class="pagination">
    <span>Page {{ current_page }} of {{ total_pages }}</span>
    <div class="pagination-controls">
        {% if current_page > 1 %}
            <a href="{{ base_url }}/page/1" class="pagination-btn">First</a>
            <a href="{{ base_url }}/page/{{ current_page - 1 }}" class="pagination-btn">&laquo; Previous</a>
        {% endif %}
        
        {% set start_page = current_page - 2 if current_page - 2 > 0 else 1 %}
        {% set end_page = current_page + 3 if current_page + 3 <= total_pages else total_pages + 1 %}
        {% for p in range(start_page, end_page) %}
            {% if p == current_page %}
                <span class="pagination-current">{{ p }}</span>
            {% else %}
                <a href="{{ base_url }}/page/{{ p }}" class="pagination-btn">{{ p }}</a>
            {% endif %}
        {% endfor %}
        
        {% if current_page < total_pages %}
            <a href="{{ base_url }}/page/{{ current_page + 1 }}" class="pagination-btn">Next &raquo;</a>
            <a href="{{ base_url }}/page/{{ total_pages }}" class="pagination-btn">Last</a>
        {% endif %}
    </div>
</div>
{% endmacro %}

{% macro render_changes_table(changes, preview_references, target_schemas, show_actions=false) %}
<table class="info-table">
    <thead>
        <tr>
            <th>ID</th>
            <th>Target Collection</th>
            <th>Target</th>
            <th>Change Type</th>
            <th>Status</th>
            <th class="changes-column">Changes</th>
            <th class="reason-column">Reason</th>
            <th>Time</th>
            <th>User</th>
            {% if show_actions %}
            <th>Actions</th>
            {% endif %}
        </tr>
    </thead>
    <tbody>
        {% for change in changes %}
            <tr>
                <td><a href="/changes/item/{{ change._id }}">{{ change._id }}</a></td>
                <td>{{ change.target_collection }}</td>
                <td>
                    {% if change.target_collection in preview_references and change.target|string in preview_references[change.target_collection] %}
                        <a href="{{ preview_references[change.target_collection][change.target|string]['link'] }}">
                            {{ preview_references[change.target_collection][change.target|string]['name'] }}
                        </a>
                    {% else %}
                        {{ change.target }}
                    {% endif %}
                </td>
                <td>{{ change.change_type }}</td>
                <td>{{ change.status }}</td>
                <td class="changes-column wrap-content">
                    {% for key, before_value in change.before_requested_data.items() %}
                        {% set label = target_schemas[change.target_collection].properties.get(key, {}).get("label", key) %}
                        {% set after_value = change.after_requested_data[key] %}
                        <div class="change-item">
                            <div class="change-label">{{ label }}:</div>
                            {% if before_value is mapping and after_value is mapping %}
                                {# Handle single dictionary #}
                                {% set all_keys = (before_value.keys() | list + after_value.keys() | list) | unique | sort %}
                                {% for dict_key in all_keys %}
                                    <div class="dict-change">
                                        <span class="dict-key">{{ dict_key }}:</span>
                                        <span class="dict-value">
                                            {{ before_value.get(dict_key, 'None') }} → {{ after_value.get(dict_key, 'None') }}
                                        </span>
                                    </div>
                                {% endfor %}
                            {% elif before_value is sequence and before_value is not string %}
                                {% if before_value and before_value[0] is mapping %}
                                    {# Handle array of dictionaries #}
                                    {% for before_dict in before_value or [] %}
                                        {% if before_dict %}
                                            {% set after_dict = after_value[loop.index0] if after_value and loop.index0 < after_value|length else {} %}
                                            <div class="array-dict-item">
                                                <div class="array-index">Item {{ loop.index }}:</div>
                                                {% set before_keys = before_dict.keys()|list if before_dict else [] %}
                                                {% set after_keys = after_dict.keys()|list if after_dict else [] %}
                                                {% set all_keys = (before_keys + after_keys)|unique|sort %}
                                                {% set seen_keys = [] %}
                                                {% for dict_key in all_keys %}
                                                    {% if dict_key not in seen_keys %}
                                                        {% set _ = seen_keys.append(dict_key) %}
                                                        <div class="dict-change">
                                                            <span class="dict-key">{{ dict_key }}:</span>
                                                            <span class="dict-value">
                                                                {% set field_schema = target_schemas[change.target_collection].properties.get(key, {}) %}
                                                                {% if field_schema.bsonType == "linked_object" %}
                                                                    {% set collection_name = field_schema.collections[0] if field_schema.collections else None %}
                                                                    {% if collection_name and collection_name in preview_references %}
                                                                        {% set before_id = before_dict.get(dict_key)|string %}
                                                                        {% set after_id = after_dict.get(dict_key)|string if after_dict else None %}
                                                                        
                                                                        {% if before_id and before_id in preview_references[collection_name] %}
                                                                            <a href="{{ preview_references[collection_name][before_id]['link'] }}">{{ preview_references[collection_name][before_id]['name'] }}</a>
                                                                        {% else %}
                                                                            None
                                                                        {% endif %}
                                                                        →
                                                                        {% if after_id and after_id in preview_references[collection_name] %}
                                                                            <a href="{{ preview_references[collection_name][after_id]['link'] }}">{{ preview_references[collection_name][after_id]['name'] }}</a>
                                                                        {% else %}
                                                                            None
                                                                        {% endif %}
                                                                    {% else %}
                                                                        {{ before_dict.get(dict_key, 'None') }} → {{ after_dict.get(dict_key, 'None') if after_dict else 'None' }}
                                                                    {% endif %}
                                                                {% else %}
                                                                    {{ before_dict.get(dict_key, 'None') }} → {{ after_dict.get(dict_key, 'None') if after_dict else 'None' }}
                                                                {% endif %}
                                                            </span>
                                                        </div>
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                    {# Show any additional items in after_value #}
                                    {% if after_value %}
                                        {% for after_dict in after_value[(before_value|length if before_value else 0):] %}
                                            {% if after_dict %}
                                                <div class="array-dict-item">
                                                    <div class="array-index">Item {{ (before_value|length if before_value else 0) + loop.index }}:</div>
                                                    {% set seen_keys = [] %}
                                                    {% for dict_key, dict_value in after_dict.items() %}
                                                        {% if dict_key not in seen_keys %}
                                                            {% set _ = seen_keys.append(dict_key) %}
                                                            <div class="dict-change">
                                                                <span class="dict-key">{{ dict_key }}:</span>
                                                                <span class="dict-value">
                                                                    {% set field_schema = target_schemas[change.target_collection].properties.get(key, {}) %}
                                                                    {% if field_schema.bsonType == "linked_object" %}
                                                                        {% set collection_name = field_schema.collections[0] if field_schema.collections else None %}
                                                                        {% if collection_name and collection_name in preview_references %}
                                                                            {% set after_id = dict_value|string %}
                                                                            None →
                                                                            {% if after_id and after_id in preview_references[collection_name] %}
                                                                                <a href="{{ preview_references[collection_name][after_id]['link'] }}">{{ preview_references[collection_name][after_id]['name'] }}</a>
                                                                            {% else %}
                                                                                None
                                                                            {% endif %}
                                                                        {% else %}
                                                                            None → {{ dict_value }}
                                                                        {% endif %}
                                                                    {% else %}
                                                                        None → {{ dict_value }}
                                                                    {% endif %}
                                                                </span>
                                                            </div>
                                                        {% endif %}
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                {% else %}
                                    {# Handle simple arrays #}
                                    <div class="array-change">
                                        <div class="array-before">
                                            <strong>Before:</strong> 
                                            {% if before_value %}
                                                [{% for item in before_value %}{{ item }}{% if not loop.last %}, {% endif %}{% endfor %}]
                                            {% else %}
                                                []
                                            {% endif %}
                                        </div>
                                        <div class="array-after">
                                            <strong>After:</strong> 
                                            {% if after_value %}
                                                [{% for item in after_value %}{{ item }}{% if not loop.last %}, {% endif %}{% endfor %}]
                                            {% else %}
                                                []
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endif %}
                            {% else %}
                                <div class="simple-data">
                                    {% set field_schema = target_schemas[change.target_collection].properties.get(key, {}) %}
                                    {% if field_schema.bsonType == "linked_object" %}
                                        {% set collection_name = field_schema.collections[0] if field_schema.collections else None %}
                                        {% if collection_name and collection_name in preview_references %}
                                            {% set before_id = before_value|string if before_value else None %}
                                            {% set after_id = after_value|string if after_value else None %}
                                            
                                            {% if before_id and before_id in preview_references[collection_name] %}
                                                <a href="{{ preview_references[collection_name][before_id]['link'] }}">{{ preview_references[collection_name][before_id]['name'] }}</a>
                                            {% else %}
                                                None
                                            {% endif %}
                                            →
                                            {% if after_id and after_id in preview_references[collection_name] %}
                                                <a href="{{ preview_references[collection_name][after_id]['link'] }}">{{ preview_references[collection_name][after_id]['name'] }}</a>
                                            {% else %}
                                                None
                                            {% endif %}
                                        {% else %}
                                            {{ before_value }} → {{ after_value }}
                                        {% endif %}
                                    {% else %}
                                        {{ before_value }} → {{ after_value }}
                                    {% endif %}
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </td>
                <td class="reason-column wrap-content">
                    {{ change.request_reason|format_discord_link|safe }}
                </td>
                {% if change.time_requested is defined and change.time_requested is not none and change.time_requested|string is not string and change.time_requested.__class__.__name__ == 'datetime' %}
                    <td>{{ change.time_requested.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                {% else %}
                    <td>{{ change.time_requested }}</td>
                {% endif %}
                <td>
                    {% if "requester" in preview_references and change.requester|string in preview_references["requester"] %}
                        <a href="{{ preview_references['requester'][change.requester|string]['link'] }}">
                            {{ preview_references['requester'][change.requester|string]['name'] }}
                        </a>
                    {% endif %}
                </td>
                {% if show_actions %}
                <td class="action-buttons">
                    {% if g.user and g.user.is_admin %}
                        <a href="/changes/item/{{ change._id }}/approve" class="btn btn-approve">Approve</a>
                        <a href="/changes/item/{{ change._id }}/deny" class="btn btn-deny">Deny</a>
                    {% endif %}
                </td>
                {% endif %}
            </tr>
        {% endfor %}
    </tbody>
</table>
{% endmacro %}

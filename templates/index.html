{% extends "layout.html" %}

{% block title %}Path of Ages - Interactive Map{% endblock %}

{% block content %}
<div class="container">
    <div class="map-controls">
        <div class="button-group">
            <button id="map1-btn" class="map-btn active">Political Map</button>
            <button id="map2-btn" class="map-btn">Terrain Map</button>
        </div>
        <div class="session-selector">
            <label for="session-select">Session: </label>
            <select id="session-select">
                {% for session in range(current_session, 0, -1) %}
                    <option value="{{ session }}" {% if loop.first %}selected{% endif %}>Session {{ session }}</option>
                {% endfor %}
            </select>
            <div class="era-display">
                <span id="era-age-text">Unknown | Unknown</span>
            </div>
        </div>
        <div class="slider-container">
            <label for="opacity-slider">Overlay Opacity: </label>
            <input type="range" id="opacity-slider" min="0" max="100" value="0">
            <span id="opacity-value">0%</span>
        </div>
    </div>
    <div id="map-viewer" class="map-viewer"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/openseadragon@3.1.0/build/openseadragon/openseadragon.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const sessionSelect = document.getElementById('session-select');
    const currentSession = parseInt(sessionSelect.value);
    const maxSession = parseInt(sessionSelect.options[0].value);
    const eraAgeText = document.getElementById('era-age-text');
    
    // Define eras and ages based on session numbers
    const eraData = [
        { maxSession: 7, era: "Tribal Era", age: "Age of Stone" },
        { maxSession: 17, era: "Tribal Era", age: "Age of Fire" },
        { maxSession: 28, era: "Ancient Era", age: "Age of Myth" },
        { maxSession: 42, era: "Ancient Era", age: "Age of Bronze" },
        { maxSession: 99, era: "Classical Era", age: "Age of Wonder" },
    ];
    
    function updateEraAge(sessionNum) {
        for (const data of eraData) {
            if (sessionNum <= data.maxSession) {
                eraAgeText.textContent = `${data.era} | ${data.age}`;
                break;
            }
        }
    }
    
    // Update era/age when session changes
    sessionSelect.addEventListener('change', () => {
        const selectedSession = parseInt(sessionSelect.value);
        updateEraAge(selectedSession);
        updateMapVisibility();
    });
    
    // Initialize era/age display
    updateEraAge(currentSession);
    
    const viewer = OpenSeadragon({
        id: "map-viewer",
        prefixUrl: "https://cdn.jsdelivr.net/npm/openseadragon@3.1.0/build/openseadragon/images/",
        showNavigationControl: true,
        navigatorPosition: "BOTTOM_RIGHT",
        maxZoomPixelRatio: 2,
        minZoomImageRatio: 0.1,
        visibilityRatio: 0.1,
        immediateRender: true,
        blendTime: 0,
        animationTime: 0.5,
        tileCache: 1000
    });

    const loadedSessions = {}; // { sessionNum: { political: TiledImage, terrain: TiledImage } }
    let currentMapType = 'political';

    // Track opacity slider
    const opacitySlider = document.getElementById('opacity-slider');
    const opacityValue = document.getElementById('opacity-value');

    function updateMapVisibility() {
        const selectedSession = parseInt(sessionSelect.value);
        const sliderVal = parseInt(opacitySlider.value);

        // Hide all maps
        for (const session in loadedSessions) {
            if (loadedSessions[session].political) loadedSessions[session].political.setOpacity(0);
            if (loadedSessions[session].terrain) loadedSessions[session].terrain.setOpacity(0);
        }

        // Show selected maps
        const sessionMaps = loadedSessions[selectedSession];
        if (sessionMaps) {
            const politicalOpacity = 1 - (sliderVal / 100);
            const terrainOpacity = sliderVal / 100;
            if (sessionMaps.political) sessionMaps.political.setOpacity(politicalOpacity);
            if (sessionMaps.terrain) sessionMaps.terrain.setOpacity(terrainOpacity);
        }
    }

    function loadSession(sessionNum) {
        if (loadedSessions[sessionNum]) return;

        loadedSessions[sessionNum] = {};
        const basePath = "https://poa-website-static-assets.s3.us-east-1.amazonaws.com/maps/dzi/dzi/";

        viewer.addTiledImage({
            tileSource: `${basePath}PoA_Political_Map_Session_${sessionNum}.dzi`,
            buildPyramid: false,
            opacity: 0,
            success: ({ item }) => {
                loadedSessions[sessionNum].political = item;
                if (parseInt(sessionSelect.value) === sessionNum) updateMapVisibility();
            }
        });

        viewer.addTiledImage({
            tileSource: getTerrainMapPath(sessionNum, basePath),
            buildPyramid: false,
            opacity: 0,
            success: ({ item }) => {
                loadedSessions[sessionNum].terrain = item;
                if (parseInt(sessionSelect.value) === sessionNum) updateMapVisibility();
            }
        });
    }

    function getTerrainMapPath(sessionNum, basePath) {
        if (sessionNum <= 17) {
            return basePath + "PoA_Geographical_Map_Tribal.dzi";
        } else if (sessionNum <= 42) {
            return basePath + "PoA_Terrain_Map_Ancient.dzi";
        } else {
            return basePath + "PoA_Terrain_Map_Classical.dzi";
        }
    }


    // Load the current session immediately
    loadSession(currentSession);

    // Preload other sessions with a modified approach
    setTimeout(() => {
        const allSessions = Array.from(sessionSelect.options).map(opt => parseInt(opt.value));
        
        // Create a queue for loading sessions
        let loadQueue = allSessions.filter(s => s !== currentSession);
        let currentIndex = 0;
        
        // Function to load the next session in queue
        function loadNextInQueue() {
            if (currentIndex < loadQueue.length) {
                const sessionToLoad = loadQueue[currentIndex];
                
                // Skip if already loaded (might have been prioritized)
                if (!loadedSessions[sessionToLoad]) {
                    loadSession(sessionToLoad);
                }
                
                currentIndex++;
                setTimeout(loadNextInQueue, 500); // Continue with next after delay
            }
        }
        
        // Start the queue processing
        loadNextInQueue();
    }, 1500);
    
    // Function to prioritize loading a specific session
    function prioritizeSession(sessionNum) {
        if (!loadedSessions[sessionNum]) {
            loadSession(sessionNum);
        }
    }

    // Session selector logic
    sessionSelect.addEventListener('change', () => {
        const selectedSession = parseInt(sessionSelect.value);
        updateEraAge(selectedSession);
        
        // Check if the selected session is already loaded
        if (!loadedSessions[selectedSession]) {
            // If not loaded, load it immediately
            loadSession(selectedSession);
        }
        
        // Update visibility after a short delay to allow loading
        setTimeout(updateMapVisibility, 100);
    });

    // Map swap buttons
    const map1Btn = document.getElementById('map1-btn');
    const map2Btn = document.getElementById('map2-btn');

    map1Btn.addEventListener('click', () => {
        opacitySlider.value = 0;
        opacityValue.textContent = '0%';
        currentMapType = 'political';
        map1Btn.classList.add('active');
        map2Btn.classList.remove('active');
        updateMapVisibility();
    });

    map2Btn.addEventListener('click', () => {
        opacitySlider.value = 100;
        opacityValue.textContent = '100%';
        currentMapType = 'terrain';
        map2Btn.classList.add('active');
        map1Btn.classList.remove('active');
        updateMapVisibility();
    });

    // Slider listener
    opacitySlider.addEventListener('input', function () {
        const val = parseInt(this.value);
        opacityValue.textContent = val + '%';
        currentMapType = val < 50 ? 'political' : 'terrain';
        map1Btn.classList.toggle('active', val < 50);
        map2Btn.classList.toggle('active', val >= 50);
        updateMapVisibility();
    });

    // Initial render update
    setTimeout(updateMapVisibility, 500);
});
</script>
{% endblock %}
